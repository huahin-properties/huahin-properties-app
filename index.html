<!DOCTYPE html>
<html>
<head>
  <base target="_top"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --primary-green: #24d366; --bg-sale: #e8f5e9; --txt-sale: #2e7d32; --bg-rent: #ffebee; --txt-rent: #c62828; --bg-both: #e3f2fd; --txt-both: #1565c0; --bg-Available: #e8f5e9; --txt-Available: #2e7d32; }
    body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; font-weight: 300; }
    .header-filter { background-color: var(--primary-green); padding: 8px 10px 10px; border-radius: 0 0 15px 15px; position: sticky; top: 0; z-index: 1100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .search-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .search-input { flex: 1.6; border: none; border-radius: 8px; font-size: 12px; padding: 6px 10px; outline: none; height: 32px; }
    .all-btn { flex: 0.5; background: #fff; color: var(--primary-green); border: none; border-radius: 8px; font-size: 12px; cursor: pointer; height: 32px; font-weight: 400; }
    .filter-grid { display: flex; gap: 5px; }
    .filter-select { flex: 1; border: none; border-radius: 8px; font-size: 11px; padding: 0 5px; height: 32px; outline: none; background: rgba(255,255,255,0.95); }
    .container { padding: 6px; max-width: 450px; margin: 0 auto 75px; }
    .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 8px; }
    /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 3 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û */
    .compact-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; background: #fff; border-bottom: 1px solid #f0f0f0; }
    .compact-thumb { width: 45px; height: 45px; border-radius: 6px; object-fit: cover; margin-right: 10px; border: 1px solid #eee; }
    .compact-info b { font-size: 12px; color: #333; display: block; font-weight: 400; line-height: 1.1; }
    .compact-info small { font-size: 10px; color: #888; font-weight: 300; display: block; line-height: 1.3; }
    .feat-text { color: #aaa; font-size: 9px; font-weight: 300; }
    .price-black { color: #333; font-weight: 400; font-size: 12px; }
    .status-pill { font-size: 7px; padding: 1px 5px; border-radius: 50px; font-weight: 400; display: inline-block; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; height: 55px; }
    .nav-item { flex: 1; padding: 6px 0; text-align: center; font-size: 9px; color: #999; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); font-weight: 400; }
    .nav-item i { font-size: 16px; margin-bottom: 1px; display: block; }
    .menu-btn { width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 50px; font-weight: 400; cursor: pointer; margin-top: 10px; }
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 15% auto; padding: 12px; width: 85%; border-radius: 15px; max-height: 60vh; overflow-y: auto; }
    .prop-item { display: flex; align-items: center; padding: 6px; border-bottom: 1px solid #f4f4f4; cursor: pointer; }
    .prop-item img { width: 35px; height: 35px; border-radius: 5px; margin-right: 12px; object-fit: cover; }
  </style>
</head>
<body onload="initApp()">

  <div id="filterHeader" class="header-filter" style="display:none;">
    <div class="search-row"><input type="text" id="searchId" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå..." oninput="applyFilters()"><button class="all-btn" onclick="clearFilters()">All</button><select id="filterFor" class="filter-select" onchange="applyFilters()"><option value="All">‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option><option value="sale">Sale</option><option value="rent">Rent</option></select></div>
    <div class="filter-grid"><select id="filterLoc" class="filter-select" onchange="applyFilters()"><option value="All">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option><option value="Hua Hin">‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô</option><option value="Chaam">‡∏ä‡∏∞‡∏≠‡∏≥</option><option value="Pranburi">‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ</option></select><select id="filterBed" class="filter-select" onchange="applyFilters()"><option value="All">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
  </div>

  <div class="container">
    <div id="propertiesPage" style="display:none;"><div id="propertiesList"></div></div>
    
    <div id="appointPage" class="card" style="display:none;">
      <h3 style="margin:0 0 10px; font-size:14px; font-weight:400;"><i class="fa-solid fa-calendar-check"></i> ‡∏ô‡∏±‡∏î‡∏î‡∏π‡∏ö‡πâ‡∏≤‡∏ô</h3>
      <div style="border:1.2px solid #eee; padding:8px; border-radius:8px; cursor:pointer;" onclick="openPropPicker('aProp')"><span id="aPropText">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô --</span></div>
      <input type="hidden" id="aPropId">
      <input type="text" id="aClientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" style="width:100%; padding:8px; margin-top:10px; border-radius:8px; border:1.2px solid #eee; font-family: Kanit;">
      <input type="datetime-local" id="aDate" style="width:100%; padding:8px; margin-top:10px; border-radius:8px; border:1.2px solid #eee; font-family: Kanit;">
      <textarea id="aNotes" placeholder="Note" style="width:100%; padding:8px; margin-top:10px; border-radius:8px; border:1.2px solid #eee; font-family: Kanit;"></textarea>
      <button class="menu-btn" onclick="handleAddAppoint()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
    </div>

    <div id="loginPage" class="card" style="display:none; text-align:center;">
      <img src="https://img5.pic.in.th/file/secure-sv1/222892.jpg" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--primary-green);">
      <h3 style="margin:10px 0; font-size: 16px;">Agent Login</h3>
      <input type="tel" id="lPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" style="width:100%; padding:8px; border-radius:8px; border:1.2px solid #eee; font-family: Kanit;">
      <input type="password" id="lPass" placeholder="******" style="width:100%; padding:8px; margin-top:10px; border-radius:8px; border:1.2px solid #eee;">
      <button class="menu-btn" onclick="handleLogin()">Login</button>
    </div>

    <div id="propPickerModal" class="modal"><div class="modal-content"><h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏≠‡∏û‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏µ‡πâ</h4><div id="propPickerList"></div><button onclick="closePropPicker()" style="width:100%; padding:10px; background:#999; color:white; border:none; border-radius:50px; margin-top:10px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;"><div class="nav-item" id="btnStock" onclick="openProperties()"><i class="fa-solid fa-house"></i><div>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div></div><div class="nav-item" id="btnAppoint" onclick="switchPage('appointPage')"><i class="fa-solid fa-calendar-check"></i><div>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div></div><div class="nav-item active" id="btnCheckin" onclick="switchPage('propertiesPage')"><i class="fa-solid fa-file-signature"></i><div>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div></div><div class="nav-item" id="btnLogout" onclick="handleLogout()"><i class="fa-solid fa-sign-out-alt"></i><div>‡∏≠‡∏≠‡∏Å</div></div></div>

  <script>
    // ‡∏ù‡∏±‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå API ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const API_URL = "https://script.google.com/macros/s/AKfycbxw-AFboZUrCih6wRoBOabDn3ioCUfs1ltyyfFSdhZFkvyft68HWMxcRmYe2vmBmFlllQ/exec"; 
    let globalProfile = null, allHouses = [], currentTarget = '';

    async function initApp() {
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');
      if (ph && ps) {
        Swal.showLoading();
        const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
        Swal.close();
        if (res?.success) { globalProfile = res.profile; openProperties(); } else switchPage('loginPage');
      } else switchPage('loginPage');
    }

    function clearFilters() { document.getElementById('searchId').value = ''; ['filterFor','filterLoc','filterBed'].forEach(id => document.getElementById(id).value = 'All'); applyFilters(); }
    function applyFilters() { const sId = document.getElementById('searchId').value.toLowerCase(); const fF = document.getElementById('filterFor').value; const fL = document.getElementById('filterLoc').value; const fB = document.getElementById('filterBed').value; const filtered = allHouses.filter(h => (h.id.toLowerCase().includes(sId)) && (fF === 'All' || h.forStatus.toLowerCase() === fF.toLowerCase()) && (fL === 'All' || h.amphoe.includes(fL)) && (fB === 'All' || h.bed.toString() === fB)); renderList(filtered); }

    function renderList(data) {
      document.getElementById('propertiesList').innerHTML = data.map(h => {
        let price = Number(h.price.toString().replace(/[^0-9.]/g, '')).toLocaleString();
        let featDisplay = h.features ? `| <span class="feat-text">${h.features}</span>` : "";
        return `
        <div class="compact-item">
          <div style="display:flex; align-items:center;">
            <img class="compact-thumb" src="${h.img || 'https://placehold.co/100'}">
            <div class="compact-info">
              <b>${h.id} <span style="font-weight:300; font-size:9px;">[${h.type}]</span></b>
              <small>${h.forStatus} | üõèÔ∏è ${h.bed} | üöø ${h.bath}</small>
              <small style="color:#555;"><b>${h.amphoe}</b> ${featDisplay}</small>
            </div>
          </div>
          <div class="compact-right"><span class="price-black">‡∏ø ${price}</span><br><span class="status-pill" style="color:#2e7d32">${h.status}</span></div>
        </div>`;
      }).join('');
    }

    async function openProperties() { switchPage('propertiesPage'); if(allHouses.length === 0) { document.getElementById('propertiesList').innerHTML = '<div style="text-align:center; padding:15px; font-size:10px;">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å...</div>'; const res = await fetch(`${API_URL}?action=getProperties`).then(r => r.json()); allHouses = res.data; } applyFilters(); }
    async function handleAddAppoint() { const d = { action: "addAppoint", agentId: globalProfile.agentId, agentName: globalProfile.name, propertyId: document.getElementById('aPropId').value, subPropertyId: "", clientName: document.getElementById('aClientName').value, date: document.getElementById('aDate').value, notes: document.getElementById('aNotes').value }; if(!d.propertyId || !d.date) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'warning'); Swal.showLoading(); const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(d) }).then(r => r.json()); Swal.close(); if(res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => openProperties()); }
    function switchPage(id) { ['loginPage', 'propertiesPage', 'appointPage'].forEach(p => { const el = document.getElementById(p); if(el) el.style.display = 'none'; }); const t = document.getElementById(id); if(t) t.style.display = 'block'; document.getElementById('filterHeader').style.display = (id === 'propertiesPage') ? 'block' : 'none'; document.getElementById('bottomNav').style.display = (id === 'loginPage') ? 'none' : 'flex'; document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if(id === 'propertiesPage') document.getElementById('btnStock').classList.add('active'); else if(id === 'appointPage') document.getElementById('btnAppoint').classList.add('active'); }
    async function handleLogin() { const ph = document.getElementById('lPhone').value, ps = document.getElementById('lPass').value; Swal.showLoading(); const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json()); Swal.close(); if (res?.success) { localStorage.setItem('agent_phone', ph); localStorage.setItem('agent_pass', ps); globalProfile = res.profile; openProperties(); } else Swal.fire('Error', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
    function openPropPicker(t) { currentTarget = t; if(allHouses.length === 0) { fetch(`${API_URL}?action=getProperties`).then(r => r.json()).then(res => { allHouses = res.data; showPicker(); }); } else showPicker(); }
    function showPicker() { const list = document.getElementById('propPickerList'); list.innerHTML = allHouses.map(p => `<div class="prop-item" onclick="selectProperty('${p.id}')"><img src="${p.img}"><b>${p.id}</b></div>`).join(''); document.getElementById('propPickerModal').style.display = 'block'; }
    function selectProperty(id) { document.getElementById(currentTarget + 'Id').value = id; document.getElementById(currentTarget + 'Text').innerText = id; closePropPicker(); }
    function closePropPicker() { document.getElementById('propPickerModal').style.display = 'none'; }
    function handleLogout() { localStorage.clear(); location.reload(); }
  </script>
</body>
</html>
