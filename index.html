<!DOCTYPE html>
<html>
<head>
  <base target="_top"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --primary-green: #24d366; --st-Approved: #e8f5e9; --st-Approved-txt: #2e7d32; --st-Pending: #fff3e0; --st-Pending-txt: #e65100; }
    body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
    .header { background-color: var(--primary-green); color: white; padding: 20px 15px 40px; text-align: center; border-radius: 0 0 30px 30px; }
    .container { padding: 15px; max-width: 450px; margin: 0 auto 80px; }
    .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .input-group { margin-bottom: 15px; text-align: left; position: relative; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
    .input-group input { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; }
    .menu-btn { width: 100%; padding: 16px; background: var(--primary-green); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
    .agent-hub-profile { display: flex; align-items: center; gap: 12px; background: #fff; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 20px; }
    .agent-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-green); }
    .status-badge { font-size: 11px; padding: 3px 10px; border-radius: 50px; font-weight: 600; }
    .st-Pending { background: var(--st-Pending); color: var(--st-Pending-txt); }
    .st-Approved { background: var(--st-Approved); color: var(--st-Approved-txt); }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; }
    .nav-item { flex: 1; padding: 12px 0; text-align: center; color: #999; font-size: 11px; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); }
  </style>
</head>
<body onload="initApp()">

  <div class="header"><h1>HUAHIN.PROPERTIES</h1></div>

  <div class="container">
    <div id="agentHub" style="display:none;">
      <div class="agent-hub-profile">
        <img id="hImg" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="agent-img">
        <div style="text-align:left">
          <div style="font-weight:600; font-size:16px;"><span id="hName">...</span></div>
          <div style="font-size:12px; color:#666;">ID: <span id="hId">...</span></div>
          <div id="hStatus" class="status-badge st-Pending">Pending</div>
        </div>
      </div>
      
      <button class="menu-btn" onclick="switchPage('visitPage')"><i class="fa-solid fa-file-signature"></i> บันทึกพาชมบ้านใหม่</button>
      <button class="menu-btn" onclick="switchPage('historyPage')" style="background:#666;"><i class="fa-solid fa-history"></i> ประวัติการทำงาน</button>
    </div>

    <div id="loginPage" class="card" style="display:none;">
      <h3 style="margin-top:0">Agent Access</h3>
      <div class="input-group"><label>เบอร์โทรศัพท์</label><input type="tel" id="lPhone" placeholder="08x-xxxxxxx"></div>
      <div class="input-group"><label>รหัสผ่าน</label><input type="password" id="lPass"></div>
      <button class="menu-btn" onclick="handleLogin()">Login</button>
      <div style="text-align:center; font-size:13px; margin-top:10px;">ยังไม่มีบัญชี? <span onclick="switchPage('registerPage')" style="color:var(--primary-green); cursor:pointer;">สมัครสมาชิก</span></div>
    </div>

    <div id="visitPage" class="card" style="display:none;">
      <h3 style="margin-top:0">บันทึกพาชมบ้าน</h3>
      <div class="input-group"><label>Property ID</label><input type="text" id="vPropId" placeholder="HHXXXX"></div>
      <div class="input-group"><label>ชื่อลูกค้า</label><input type="text" id="vClientName"></div>
      <button class="menu-btn" onclick="handleRecordVisit()">ส่งข้อมูล</button>
      <button class="menu-btn" onclick="switchPage('agentHub')" style="background:#eee; color:#333;">กลับหน้าหลัก</button>
    </div>

    <div id="historyPage" class="card" style="display:none;">
      <h3 style="margin-top:0">ประวัติการทำงาน</h3>
      <div id="historyList">Loading...</div>
      <button class="menu-btn" onclick="switchPage('agentHub')" style="margin-top:15px;">กลับ</button>
    </div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;">
    <div class="nav-item active" onclick="switchPage('agentHub')"><i class="fa-solid fa-user-tie"></i><div>My Hub</div></div>
    <div class="nav-item" onclick="handleLogout()"><i class="fa-solid fa-sign-out"></i><div>ออก</div></div>
  </div>

  <script>
    const API_URL = "URL_APPS_SCRIPT_ของคุณ"; 
    let globalProfile = null;

    async function initApp() {
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');
      if (ph && ps) {
        const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
        if (res?.success) { globalProfile = res.profile; showHub(); } 
        else switchPage('loginPage');
      } else switchPage('loginPage');
    }

    function showHub() {
      document.getElementById('hName').innerText = globalProfile.name;
      document.getElementById('hId').innerText = globalProfile.agentId;
      document.getElementById('hImg').src = globalProfile.imgUrl || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
      const status = globalProfile.status ? globalProfile.status.toLowerCase() : 'pending';
      const badge = document.getElementById('hStatus');
      if (status === 'admin' || status === 'approved' || status === 'active') { badge.innerText = "Verified"; badge.className = "status-badge st-Approved"; }
      else { badge.innerText = "Pending"; badge.className = "status-badge st-Pending"; }
      switchPage('agentHub');
    }

    async function handleLogin() {
      const ph = document.getElementById('lPhone').value, ps = document.getElementById('lPass').value;
      const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
      if (res?.success) { localStorage.setItem('agent_phone', ph); localStorage.setItem('agent_pass', ps); globalProfile = res.profile; showHub(); }
      else Swal.fire('Error', 'ไม่ถูกต้อง', 'error');
    }

    function switchPage(id) {
      ['agentHub','loginPage','visitPage','historyPage'].forEach(p => document.getElementById(p).style.display = 'none');
      document.getElementById(id).style.display = 'block';
      document.getElementById('bottomNav').style.display = (id === 'loginPage') ? 'none' : 'flex';
      if(id === 'historyPage') loadHistory();
    }

    function handleLogout() { localStorage.clear(); location.reload(); }
  </script>
</body>
</html>
