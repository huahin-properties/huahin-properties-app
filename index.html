<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --primary-green: #24d366; --app-red: #d32f2f; --st-available: #2e7d32; --st-reserved: #e65100; }
    body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
    
    /* Header & Admin Profile */
    .header { background: var(--primary-green); color: white; padding: 25px 15px 45px; text-align: center; border-radius: 0 0 30px 30px; position: relative; }
    .logo-circle { width: 70px; height: 70px; background: white; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #fff; }
    .logo-circle img { width: 90%; object-fit: contain; }
    .admin-top { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; position: absolute; right: 20px; top: 20px; object-fit: cover; }

    .container { padding: 15px; max-width: 450px; margin: 0 auto 80px; }
    .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
    
    /* Compact Card Style */
    .prop-card { display: flex; background: white; border-radius: 12px; margin-bottom: 12px; padding: 10px; position: relative; border-left: 5px solid var(--primary-green); box-shadow: 0 2px 5px rgba(0,0,0,0.05); align-items: center; }
    .prop-img-box { width: 85px; height: 85px; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
    .prop-img { width: 100%; height: 100%; object-fit: cover; }
    .prop-info { flex-grow: 1; padding-left: 12px; text-align: left; }
    .prop-title { font-weight: 600; font-size: 15px; color: #333; margin-bottom: 3px; }
    .prop-price { color: var(--app-red); font-weight: 600; font-size: 14px; }
    .prop-specs { display: flex; gap: 10px; font-size: 11px; color: #888; margin-top: 5px; }
    
    /* Status Badge Chips */
    .status-chip { position: absolute; top: 10px; right: 10px; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 10px; display: flex; align-items: center; gap: 4px; }
    .chip-available { background: #e8f5e9; color: #2e7d32; }
    .chip-reserved { background: #fff3e0; color: #e65100; }
    
    .menu-btn { width: 100%; padding: 16px; border: none; border-radius: 50px; background: var(--primary-green); color: white; font-weight: 600; font-size: 16px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; }
    .nav-item { flex: 1; padding: 12px 0; text-align: center; color: #999; font-size: 11px; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); }
  </style>
</head>
<body onload="initApp()">

  <div id="loadingScreen"><div class="spinner"></div><p>Loading...</p></div>

  <div class="header">
    <img src="" id="adminTopImg" class="admin-top" style="display:none">
    <div class="logo-circle"><img src="https://img5.pic.in.th/file/secure-sv1/222892.jpg"></div>
    <h1 style="margin:0; font-size:18px;">HUAHIN.PROPERTIES</h1>
    <p id="subTitle" style="margin:5px 0 0; font-size:13px; opacity:0.8;">Property Portal</p>
  </div>

  <div class="container">
    <div id="startPage" style="display:none; text-align: center;">
      <div class="card">
        <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h3>
        <button class="menu-btn" onclick="enterAsCustomer()"><i class="fa-solid fa-house-user"></i> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
        <div style="margin: 20px 0; color: #ccc;">- ‡∏´‡∏£‡∏∑‡∏≠ -</div>
        <button class="menu-btn" onclick="switchPage('loginPage')" style="background:#666;"><i class="fa-solid fa-user-lock"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå</button>
      </div>
    </div>

    <div id="propertiesPage" style="display:none;">
      <h3 id="pageTitle" style="text-align:left; margin-bottom:15px;">üè† ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
      <div id="propertiesList"></div>
    </div>

    <div id="loginPage" class="card" style="display:none;">
        <h3 id="hLogin">Login</h3>
        <input type="tel" id="lPhone" placeholder="08x-xxxxxxx" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
        <input type="password" id="lPass" placeholder="Password" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;">
        <button class="menu-btn" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <span onclick="switchPage('startPage')" style="text-decoration:underline; cursor:pointer; font-size:13px; color:#666;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
    </div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;">
    <div class="nav-item active" onclick="loadCategory('home')"><i class="fa-solid fa-house"></i><div>Home</div></div>
    <div class="nav-item" onclick="loadCategory('sale')"><i class="fa-solid fa-tags"></i><div>‡∏Ç‡∏≤‡∏¢</div></div>
    <div class="nav-item" onclick="loadCategory('rent')"><i class="fa-solid fa-key"></i><div>‡πÄ‡∏ä‡πà‡∏≤</div></div>
    <div class="nav-item" id="adminMenu" style="display:none;" onclick="switchPage('profilePage')"><i class="fa-solid fa-user-gear"></i><div>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyLB6o3Nqm8QtYSkneLHDva0T8hxkLHVl5iu1EM2IrswK8uyPkGQ4VlvP77nXHIBMB7KA/exec";
    let currentRole = "customer", allData = [];

    async function initApp() {
      const s = await callApi({ action: "getSettings" });
      if(s?.settings?.admin_photo_url) { document.getElementById('adminTopImg').src = s.settings.admin_photo_url; document.getElementById('adminTopImg').style.display='block'; }
      
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');
      if (ph && ps) handleLogin(ph, ps); else switchPage('startPage');
      document.getElementById('loadingScreen').style.display = 'none';
    }

    function enterAsCustomer() { currentRole = "customer"; switchPage('propertiesPage'); loadCategory('home'); }

    async function handleLogin(ph, ps) {
      ph = ph || document.getElementById('lPhone').value; ps = ps || document.getElementById('lPass').value;
      const res = await callApi({ action: "login", phone: ph, password: ps });
      if(res?.success) {
        currentRole = res.role;
        localStorage.setItem('agent_phone', ph); localStorage.setItem('agent_pass', ps);
        if(currentRole === 'admin') document.getElementById('adminMenu').style.display = 'block';
        switchPage('propertiesPage'); loadCategory('home');
      } else if(!ph) switchPage('startPage');
    }

    async function loadCategory(cat) {
      if(allData.length === 0) {
        Swal.showLoading();
        allData = await callApi({ action: "getProperties", role: currentRole, lang: "th" });
        Swal.close();
      }
      renderList(cat);
    }

    function renderList(cat) {
      const list = document.getElementById('propertiesList'); list.innerHTML = '';
      allData.forEach(p => {
        const isAvail = p.status.toLowerCase() === 'available';
        const chipClass = isAvail ? 'chip-available' : 'chip-reserved';
        
        let card = `
          <div class="prop-card">
            <div class="prop-img-box"><img src="${p.img || 'https://placehold.co/100'}" class="prop-img"></div>
            <div class="prop-info">
              <div class="prop-title">${p.project}</div>
              <div class="prop-price">‡∏ø ${p.price}</div>
              <div class="prop-specs">
                <span><i class="fa-solid fa-bed"></i> ${p.bed}</span>
                <span><i class="fa-solid fa-bath"></i> ${p.bath}</span>
                <span>ID: ${p.id}</span>
              </div>`;
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        if(currentRole !== 'customer') {
          card += `<div style="font-size:11px; color:green; margin-top:5px; border-top:1px dashed #eee; padding-top:5px;">üí∞ Commission: ${p.commission || '-'}</div>`;
        }
        if(currentRole === 'admin') {
          card += `<div style="font-size:11px; color:orange;">üîí Cost: ${p.net_price} | Owner: ${p.owner_phone}</div>`;
        }
        
        card += `</div><div class="status-chip ${chipClass}"><span style="width:6px; height:6px; background:currentColor; border-radius:50%;"></span> ${p.status}</div></div>`;
        list.innerHTML += card;
      });
    }

    function switchPage(id) {
      ['startPage','loginPage','propertiesPage'].forEach(p => document.getElementById(p).style.display = 'none');
      document.getElementById(id).style.display = 'block';
      document.getElementById('bottomNav').style.display = (id === 'propertiesPage') ? 'flex' : 'none';
    }
    async function callApi(p) { const q = new URLSearchParams(p).toString(); const r = await fetch(`${API_URL}?${q}`); return await r.json(); }
  </script>
</body>
</html>
