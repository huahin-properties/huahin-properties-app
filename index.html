<!DOCTYPE html>
<html>
<head>
  <base target="_top"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --primary-green: #24d366; --bg-Appro: #e8f5e9; --txt-Appro: #2e7d32; --bg-Pending: #fff3e0; --txt-Pending: #e65100; --bg-Rejected: #ffebee; --txt-Rejected: #c62828; }
    body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
    .header { background-color: var(--primary-green); color: white; padding: 12px 15px 25px; text-align: center; border-radius: 0 0 25px 25px; }
    .header h1 { font-size: 14px; margin: 0; letter-spacing: 1px; }
    .container { padding: 12px; max-width: 450px; margin: 0 auto 80px; }
    .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
    
    .login-logo { width: 75px; height: 75px; border-radius: 50%; object-fit: cover; margin: 0 auto 12px; display: block; border: 2.5px solid var(--primary-green); }
    .input-group { margin-bottom: 10px; text-align: left; }
    .input-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 13px; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 12px; box-sizing: border-box; font-family: 'Kanit'; font-size: 15px; background: #fafafa; outline: none; }
    
    /* ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Property */
    .prop-picker-btn { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 12px; background: #fff; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 15% auto; padding: 15px; width: 85%; border-radius: 20px; max-height: 70vh; overflow-y: auto; }
    .prop-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f4f4f4; cursor: pointer; }
    .prop-item img { width: 35px; height: 35px; border-radius: 6px; object-fit: cover; margin-right: 12px; }

    .menu-btn { width: 100%; padding: 14px; background: var(--primary-green); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; font-size: 15px; }
    
    /* Bottom Nav ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .nav-item { flex: 1; padding: 8px 0; text-align: center; font-size: 9px; color: #999; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); font-weight: 600; }
    .nav-item i { font-size: 18px; margin-bottom: 2px; display: block; }
    
    /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö Compact */
    .hist-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border-bottom: 1px solid #f2f2f2; }
    .hist-thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; margin-right: 10px; }
    .status-pill { font-size: 9px; padding: 1px 6px; border-radius: 50px; font-weight: 600; }
    .pill-Appro { background: var(--bg-Appro); color: var(--txt-Appro); }
    .pill-Pending { background: var(--bg-Pending); color: var(--txt-Pending); }
    .pill-Rejected { background: var(--bg-Rejected); color: var(--txt-Rejected); }
    .img-preview { width: 70px; height: 70px; border-radius: 10px; border: 2px dashed #ccc; object-fit: cover; cursor: pointer; }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô */
    .stock-item { display: flex; background: #fff; border-radius: 15px; padding: 10px; margin-bottom: 10px; border: 1px solid #eee; align-items: center; }
    .stock-thumb { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; margin-right: 12px; }
  </style>
</head>
<body onload="initApp()">

  <div class="header"><h1>HUAHIN.PROPERTIES</h1></div>

  <div class="container">
    <div id="loginPage" class="card" style="display:none; text-align:center;">
      <img src="https://img5.pic.in.th/file/secure-sv1/222892.jpg" class="login-logo">
      <h3 style="margin-top:0; font-size: 18px;">Agent Login</h3>
      <div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="lPhone" placeholder="08x-xxxxxxx"></div>
      <div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="lPass" placeholder="******"></div>
      <button class="menu-btn" onclick="handleLogin()">Login</button>
      <div style="margin-top:15px; font-size:14px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <span onclick="switchPage('registerPage')" style="color:var(--primary-green); font-weight:600; cursor:pointer;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></div>
    </div>

    <div id="registerPage" class="card" style="display:none;"><h3 style="margin-top:0;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå</h3><div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="rName"></div><div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="rPhone"></div><div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="rPass" placeholder="******"></div><button class="menu-btn" onclick="handleRegister()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button><div onclick="switchPage('loginPage')" style="text-align:center; font-size:14px; margin-top:10px; cursor:pointer;">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div></div>

    <div id="visitPage" style="display:none;">
      <div class="card" style="padding: 10px; margin-bottom: 12px;"><div style="display:flex; align-items:center; gap:10px;"><img id="vAgentImg" src="" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--primary-green);"><div style="text-align:left"><div style="font-weight:600; font-size:13px;"><span id="vDispName"></span> <small id="vDispRole" style="color:#888;"></small></div><div style="font-size:11px; color:#666;">ID: <span id="vDispId"></span> <span id="vStatusPill" class="status-pill"></span></div></div></div></div>
      <div id="checkinForm" class="card">
        <h3 style="margin-top:0; font-size: 16px;"><i class="fa-solid fa-file-signature"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏≤‡∏ä‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h3>
        <div class="input-group"><label>Property ID (‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å)</label><div class="prop-picker-btn" onclick="openPropPicker('vProp')"><div id="vPropDisplay" style="display:flex; align-items:center;"><img id="vPropImg" src="" style="width:25px; height:25px; border-radius:4px; margin-right:8px; display:none;"><span id="vPropText">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</span></div><i class="fa-solid fa-chevron-down" style="font-size:12px; color:#999;"></i></div><input type="hidden" id="vPropId"></div>
        <div class="input-group"><label>‡∏¢‡∏π‡∏ô‡∏¥‡∏ï / ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label><input type="text" id="vSubPropId" placeholder="‡πÄ‡∏ä‡πà‡∏ô HH0001,M14,HH0005,M12"></div>
        <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="vClientName"></div>
        <div class="input-group"><label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ (2 ‡∏£‡∏π‡∏õ)</label><div style="display:flex; gap:10px; justify-content:center;"><img id="vImg1" src="https://placehold.co/70?text=1" class="img-preview" onclick="document.getElementById('file1').click()"><img id="vImg2" src="https://placehold.co/70?text=2" class="img-preview" onclick="document.getElementById('file2').click()"><input type="file" id="file1" style="display:none" onchange="previewImg(this, 'vImg1')"><input type="file" id="file2" style="display:none" onchange="previewImg(this, 'vImg2')"></div></div>
        <div class="input-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label><textarea id="vNotes" rows="2"></textarea></div>
        <button class="menu-btn" onclick="getLocation()" style="background:#4285F4; padding: 12px; margin-top:5px;"><i class="fa-solid fa-location-dot"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô GPS</button>
        <button class="menu-btn" onclick="handleRecordVisit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="menu-btn" onclick="switchPage('historyPage')" style="background:#666; font-size: 12px;">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</button>
      </div>
      <div id="lockMessage" class="card" style="display:none; text-align:center;"><i class="fa-solid fa-lock" style="font-size:40px; color:#e65100; margin-bottom:10px;"></i><h3>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3></div>
    </div>

    <div id="appointPage" class="card" style="display:none;">
      <h3 style="margin-top:0; font-size: 18px;"><i class="fa-solid fa-calendar-check"></i> ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
      <div class="input-group"><label>Property ID (‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å)</label><div class="prop-picker-btn" onclick="openPropPicker('aProp')"><div id="aPropDisplay" style="display:flex; align-items:center;"><img id="aPropImg" src="" style="width:25px; height:25px; border-radius:4px; margin-right:8px; display:none;"><span id="aPropText">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</span></div><i class="fa-solid fa-chevron-down" style="font-size:12px; color:#999;"></i></div><input type="hidden" id="aPropId"></div>
      <div class="input-group"><label>‡∏¢‡∏π‡∏ô‡∏¥‡∏ï / ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label><input type="text" id="aSubPropId" placeholder="‡πÄ‡∏ä‡πà‡∏ô HH0001,M14..."></div>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="aClientName"></div>
      <div class="input-group"><label>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤</label><input type="datetime-local" id="aDate"></div>
      <div class="input-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Note)</label><textarea id="aNotes" rows="2"></textarea></div>
      <button class="menu-btn" onclick="handleAddAppoint()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
    </div>

    <div id="propertiesPage" style="display:none;">
      <h3 style="margin-left:5px; font-size: 18px;">üè† ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏≠‡∏û‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏µ‡πâ</h3>
      <div id="propertiesList"></div>
    </div>

    <div id="historyPage" style="display:none; background: #fff; border-radius: 20px; overflow: hidden;">
      <div style="padding: 12px; border-bottom: 1.5px solid #f4f4f4; display: flex; justify-content: space-between;"><b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏≤‡∏ä‡∏°</b><i class="fa-solid fa-rotate" onclick="loadHistory()" style="color:#999;"></i></div>
      <div id="historyList"></div><div style="padding: 12px;"><button class="menu-btn" onclick="switchPage('visitPage')">‡∏Å‡∏•‡∏±‡∏ö</button></div>
    </div>

    <div id="propPickerModal" class="modal"><div class="modal-content"><h4 style="margin-top:0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏≠‡∏û‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏µ‡πâ</h4><div id="propPickerList"></div><button class="menu-btn" style="background:#999; margin-top:15px;" onclick="closePropPicker()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;">
    <div class="nav-item" id="btnStock" onclick="openProperties()"><i class="fa-solid fa-house"></i><div>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div></div>
    <div class="nav-item" id="btnAppoint" onclick="switchPage('appointPage')"><i class="fa-solid fa-calendar-check"></i><div>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div></div>
    <div class="nav-item" id="btnCheckin" onclick="showVisitPage()"><i class="fa-solid fa-file-signature"></i><div>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div></div>
    <div class="nav-item" id="btnLogout" onclick="handleLogout()"><i class="fa-solid fa-sign-out-alt"></i><div>‡∏≠‡∏≠‡∏Å</div></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyLB6o3Nqm8QtYSkneLHDva0T8hxkLHVl5iu1EM2IrswK8uyPkGQ4VlvP77nXHIBMB7KA/exec"; 
    let globalProfile = null, img1Base64 = "", img2Base64 = "", locationLink = "", propertyList = [], currentTarget = '';

    async function initApp() {
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');
      if (ph && ps) {
        const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
        if (res?.success) { globalProfile = res.profile; showVisitPage(); } 
        else switchPage('loginPage');
      } else switchPage('loginPage');
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
    function switchPage(id) {
      ['loginPage', 'registerPage', 'visitPage', 'historyPage', 'propertiesPage', 'appointPage'].forEach(p => { if(document.getElementById(p)) document.getElementById(p).style.display = 'none'; });
      document.getElementById(id).style.display = 'block';
      document.getElementById('bottomNav').style.display = (id === 'loginPage' || id === 'registerPage') ? 'none' : 'flex';
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏à‡∏≤‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
      if(id === 'propertiesPage') document.getElementById('btnStock').classList.add('active');
      else if(id === 'appointPage') document.getElementById('btnAppoint').classList.add('active');
      else if(id === 'visitPage' || id === 'historyPage') document.getElementById('btnCheckin').classList.add('active');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å
    async function openProperties() {
      switchPage('propertiesPage');
      const list = document.getElementById('propertiesList');
      list.innerHTML = '<div style="text-align:center; padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å...</div>';
      const res = await fetch(`${API_URL}?action=getProperties`).then(r => r.json());
      list.innerHTML = res.data.map(h => `
        <div class="stock-item">
          <img class="stock-thumb" src="${h.img || 'https://placehold.co/100'}">
          <div style="flex:1;">
            <b style="font-size:15px; color:#333;">${h.id}</b><br>
            <small style="color:#666;">${h.title}</small><br>
            <span style="color:red; font-weight:600;">‡∏ø ${h.price}</span>
          </div>
          <div class="status-pill pill-Appro" style="font-size:9px;">${h.status}</div>
        </div>`).join('');
    }

    async function fetchPropertyIds() {
      const res = await fetch(`${API_URL}?action=getPropertyListData`).then(r => r.json());
      propertyList = res.data;
    }

    function openPropPicker(target) {
        currentTarget = target;
        if(propertyList.length === 0) {
            fetchPropertyIds().then(() => showPicker());
        } else { showPicker(); }
    }
    function showPicker() {
        const list = document.getElementById('propPickerList');
        list.innerHTML = propertyList.map(p => `<div class="prop-item" onclick="selectProperty('${p.id}', '${p.img}')"><img src="${p.img}"><b>${p.id}</b></div>`).join('');
        document.getElementById('propPickerModal').style.display = 'block';
    }
    function selectProperty(id, img) {
        document.getElementById(currentTarget + 'Id').value = id;
        document.getElementById(currentTarget + 'Text').innerText = id;
        const imgEl = document.getElementById(currentTarget + 'Img');
        imgEl.src = img; imgEl.style.display = 'block';
        closePropPicker();
    }
    function closePropPicker() { document.getElementById('propPickerModal').style.display = 'none'; }

    function showVisitPage() {
      const p = globalProfile;
      document.getElementById('vDispName').innerText = p.name;
      document.getElementById('vDispId').innerText = p.agentId;
      document.getElementById('vAgentImg').src = p.imgUrl || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
      document.getElementById('vDispRole').innerText = `[${p.roleDisplay}]`;
      const badge = document.getElementById('vStatusPill');
      badge.innerText = p.status;
      if (p.status.toLowerCase().includes('appro') || p.roleDisplay === 'Admin') {
        badge.className = "status-pill pill-Appro";
        document.getElementById('checkinForm').style.display = 'block'; document.getElementById('lockMessage').style.display = 'none';
        fetchPropertyIds();
      } else {
        badge.className = "status-pill pill-Pending";
        document.getElementById('checkinForm').style.display = 'none'; document.getElementById('lockMessage').style.display = 'block';
      }
      switchPage('visitPage');
    }

    async function loadHistory() {
      const res = await fetch(`${API_URL}?action=getVisitHistory&agentId=${globalProfile.agentId}`).then(r => r.json());
      const list = document.getElementById('historyList');
      list.innerHTML = res.history.map(item => {
        let stClass = item.status.toLowerCase().includes("appro") ? "pill-Appro" : (item.status.toLowerCase().includes("rejec") ? "pill-Rejected" : "pill-Pending");
        return `<div class="hist-item"><div style="display:flex; align-items:center;"><img style="width:40px;height:40px;border-radius:6px;object-fit:cover;margin-right:10px" src="${item.propImg}"><div><b style="font-size:12px;">${item.propertyId} ${item.subPropertyId?'('+item.subPropertyId+')':''}</b><br><small style="font-size:11px; color:#666;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${item.clientName}</small></div></div><div style="text-align:right;"><div class="status-pill ${stClass}">${item.status}</div><br><small style="font-size:9px; color:#bbb;">${item.date.split(' ')[0]}</small></div></div>`;
      }).join('');
    }

    async function handleLogin() { const ph = document.getElementById('lPhone').value, ps = document.getElementById('lPass').value; Swal.showLoading(); const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json()); Swal.close(); if (res?.success) { localStorage.setItem('agent_phone', ph); localStorage.setItem('agent_pass', ps); globalProfile = res.profile; showVisitPage(); } else Swal.fire('Error', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', 'error'); }
    async function handleRegister() { const data = { action: "register", name: document.getElementById('rName').value, phone: document.getElementById('rPhone').value, password: document.getElementById('rPass').value }; Swal.showLoading(); const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json()); Swal.close(); if(res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success').then(() => switchPage('loginPage')); }
    async function handleRecordVisit() { const data = { action: "recordVisit", agentId: globalProfile.agentId, agentName: globalProfile.name, agentPhone: localStorage.getItem('agent_phone'), propertyId: document.getElementById('vPropId').value, subPropertyId: document.getElementById('vSubPropId').value, clientName: document.getElementById('vClientName').value, notes: document.getElementById('vNotes').value, image1: img1Base64, image2: img2Base64, locationLink: locationLink }; if (!data.propertyId || !data.clientName) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'warning'); Swal.showLoading(); const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json()); Swal.close(); if (res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => location.reload()); }
    async function handleAddAppoint() { const data = { action: "addAppoint", agentId: globalProfile.agentId, agentName: globalProfile.name, propertyId: document.getElementById('aPropId').value, subPropertyId: document.getElementById('aSubPropId').value, clientName: document.getElementById('aClientName').value, date: document.getElementById('aDate').value, notes: document.getElementById('aNotes').value }; if(!data.propertyId || !data.date) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning'); Swal.showLoading(); const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json()); Swal.close(); if(res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => showVisitPage()); }
    function previewImg(i, id) { if (i.files && i.files[0]) { const r = new FileReader(); r.onload = (e) => { document.getElementById(id).src = e.target.result; if (id === 'vImg1') img1Base64 = e.target.result; else img2Base64 = e.target.result; }; r.readAsDataURL(i.files[0]); } }
    function getLocation() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((pos) => { locationLink = `http://googleusercontent.com/maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`; Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success'); }); } }
    function handleLogout() { localStorage.clear(); location.reload(); }
  </script>
</body>
</html>
