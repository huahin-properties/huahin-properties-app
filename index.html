<!DOCTYPE html>
<html>
<head>
  <base target="_top"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { 
      --primary-green: #24d366; 
      --bg-sale: #e8f5e9; --txt-sale: #2e7d32;
      --bg-rent: #ffebee; --txt-rent: #c62828;
      --bg-both: #e3f2fd; --txt-both: #1565c0;
      --bg-Available: #e8f5e9; --txt-Available: #2e7d32;
      --bg-Reserved: #fff3e0; --txt-Reserved: #e65100;
      --bg-Sold: #ffebee; --txt-Sold: #c62828;
    }
    body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; font-weight: 300; }
    
    /* ‡πÅ‡∏ú‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
    .header-filter { background-color: var(--primary-green); padding: 8px 10px 10px; border-radius: 0 0 15px 15px; position: sticky; top: 0; z-index: 1100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .filter-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° All */
    .search-input { flex: 1.8; border: none; border-radius: 8px; font-family: 'Kanit'; font-size: 12px; padding: 6px 10px; outline: none; }
    .all-btn { flex: 0.6; background: #fff; color: var(--primary-green); border: none; border-radius: 8px; font-size: 12px; padding: 6px 0; font-weight: 400; cursor: pointer; text-align: center; }
    .filter-select { flex: 1; border: none; border-radius: 8px; font-family: 'Kanit'; font-size: 11px; padding: 6px 5px; outline: none; background: rgba(255,255,255,0.95); }

    .container { padding: 6px; max-width: 450px; margin: 0 auto 70px; }
    
    /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Compact ‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏î‡πâ 6 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
    .compact-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; background: #fff; border-bottom: 1px solid #f0f0f0; }
    .compact-thumb { width: 45px; height: 45px; border-radius: 6px; object-fit: cover; margin-right: 10px; border: 1px solid #eee; }
    .compact-info b { font-size: 12px; color: #333; display: block; font-weight: 400; line-height: 1.1; }
    .compact-info small { font-size: 10px; color: #888; font-weight: 300; display: block; line-height: 1.2; }
    .price-black { color: #333; font-weight: 400; font-size: 12px; }

    .status-pill { font-size: 7px; padding: 1px 5px; border-radius: 50px; font-weight: 400; display: inline-block; margin-top: 1px; }
    .for-pill { font-size: 8px; padding: 0px 4px; border-radius: 4px; font-weight: 300; }
    .pill-sale { background: var(--bg-sale); color: var(--txt-sale); }
    .pill-rent { background: var(--bg-rent); color: var(--txt-rent); }
    .pill-both { background: var(--bg-both); color: var(--txt-both); }

    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; height: 55px; }
    .nav-item { flex: 1; padding: 6px 0; text-align: center; font-size: 9px; color: #999; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); font-weight: 400; }
    .nav-item i { font-size: 16px; margin-bottom: 1px; display: block; }

    .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 8px; }
    .login-logo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: 0 auto 8px; border: 2px solid var(--primary-green); }
    .menu-btn { width: 100%; padding: 10px; background: var(--primary-green); color: white; border: none; border-radius: 50px; font-weight: 400; cursor: pointer; margin-bottom: 6px; font-size: 14px; }
  </style>
</head>
<body onload="initApp()">

  <div id="filterHeader" class="header-filter" style="display:none;">
    <div class="filter-row">
      <input type="text" id="searchId" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå..." oninput="applyFilters()">
      <button class="all-btn" onclick="clearAllFilters()">All</button>
      <select id="filterFor" class="filter-select" onchange="applyFilters()">
        <option value="All">‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
        <option value="sale">Sale</option>
        <option value="rent">Rent</option>
        <option value="both">Both</option>
      </select>
    </div>
    <div class="filter-row" style="margin-bottom:0;">
      <select id="filterLoc" class="filter-select" onchange="applyFilters()">
        <option value="All">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
        <option value="Hua Hin">‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô</option>
        <option value="Chaam">‡∏ä‡∏∞‡∏≠‡∏≥</option>
        <option value="Pranburi">‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ</option>
      </select>
      <select id="filterType" class="filter-select" onchange="applyFilters()">
        <option value="All">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
        <option value="‡∏ö‡πâ‡∏≤‡∏ô">‡∏ö‡πâ‡∏≤‡∏ô</option>
        <option value="‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î">‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î</option>
      </select>
      <select id="filterBed" class="filter-select" onchange="applyFilters()">
        <option value="All">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô</option>
        <option value="1">1 ‡∏ô‡∏≠‡∏ô</option>
        <option value="2">2 ‡∏ô‡∏≠‡∏ô</option>
        <option value="3">3 ‡∏ô‡∏≠‡∏ô</option>
        <option value="4">4+ ‡∏ô‡∏≠‡∏ô</option>
      </select>
    </div>
  </div>

  <div class="container">
    <div id="propertiesPage" style="display:none;"><div id="propertiesList"></div></div>

    <div id="visitPage" style="display:none;">
      <div class="card" style="padding: 8px; margin-bottom: 10px;"><div style="display:flex; align-items:center; gap:8px;"><img id="vAgentImg" src="" style="width:38px; height:38px; border-radius:50%; border:1.5px solid var(--primary-green);"><div style="text-align:left"><div style="font-weight:400; font-size:12px;"><span id="vDispName"></span> <small id="vDispRole" style="color:#888;"></small></div><div style="font-size:9px; color:#666;">ID: <span id="vDispId"></span> <span id="vStatusPill" class="status-pill" style="background:#e8f5e9; color:#2e7d32;">Approved</span></div></div></div></div>
      <div id="checkinForm" class="card">
        <h3 style="margin-top:0; font-size: 15px; font-weight:400;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏≤‡∏ä‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h3>
        <div class="input-group" style="margin-bottom:6px;"><label style="font-size:11px;">Property ID</label><input type="text" id="vPropId" style="width:100%; padding:8px; border-radius:8px; border:1.2px solid #eee;" placeholder="‡πÄ‡∏ä‡πà‡∏ô HH0001"></div>
        <div class="input-group" style="margin-bottom:6px;"><label style="font-size:11px;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="vClientName" style="width:100%; padding:8px; border-radius:8px; border:1.2px solid #eee;"></div>
        <button class="menu-btn" onclick="handleRecordVisit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="menu-btn" onclick="switchPage('historyPage')" style="background:#666; font-size: 11px;">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>

    <div id="loginPage" class="card" style="display:none; text-align:center;"><img src="https://img5.pic.in.th/file/secure-sv1/222892.jpg" class="login-logo"><h3 style="margin:0 0 8px; font-size: 16px; font-weight:400;">Agent Login</h3><div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="lPhone" placeholder="08x-xxxxxxx" style="width:100%; padding:8px; border-radius:8px; border:1.2px solid #eee;"></div><div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="lPass" placeholder="******" style="width:100%; padding:8px; border-radius:8px; border:1.2px solid #eee;"></div><button class="menu-btn" onclick="handleLogin()">Login</button></div>
    
    <div id="historyPage" style="display:none; background: #fff; border-radius: 12px; overflow: hidden;"><div id="historyList"></div><div style="padding: 10px;"><button class="menu-btn" onclick="switchPage('visitPage')">‡∏Å‡∏•‡∏±‡∏ö</button></div></div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;"><div class="nav-item" id="btnStock" onclick="openProperties()"><i class="fa-solid fa-house"></i><div>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div></div><div class="nav-item" id="btnAppoint" onclick="switchPage('visitPage')"><i class="fa-solid fa-calendar-check"></i><div>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div></div><div class="nav-item active" id="btnCheckin" onclick="showVisitPage()"><i class="fa-solid fa-file-signature"></i><div>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div></div><div class="nav-item" id="btnLogout" onclick="handleLogout()"><i class="fa-solid fa-sign-out-alt"></i><div>‡∏≠‡∏≠‡∏Å</div></div></div>

  <script>
    const API_URL = "‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå_API_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"; 
    let globalProfile = null, allHouses = [];

    async function initApp() {
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');
      if (ph && ps) {
        const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
        if (res?.success) { globalProfile = res.profile; showVisitPage(); } 
        else switchPage('loginPage');
      } else switchPage('loginPage');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Clear ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
    function clearAllFilters() {
      document.getElementById('searchId').value = '';
      document.getElementById('filterFor').value = 'All';
      document.getElementById('filterLoc').value = 'All';
      document.getElementById('filterType').value = 'All';
      document.getElementById('filterBed').value = 'All';
      applyFilters();
    }

    function applyFilters() {
      const sId = document.getElementById('searchId').value.toLowerCase();
      const fFor = document.getElementById('filterFor').value;
      const fLoc = document.getElementById('filterLoc').value;
      const fType = document.getElementById('filterType').value;
      const fBed = document.getElementById('filterBed').value;

      const filtered = allHouses.filter(h => {
        const matchId = h.id.toLowerCase().includes(sId);
        const matchFor = fFor === 'All' || h.forStatus.toLowerCase() === fFor.toLowerCase();
        const matchLoc = fLoc === 'All' || h.amphoe.includes(fLoc);
        const matchType = fType === 'All' || h.type.includes(fType);
        const matchBed = fBed === 'All' || h.bed.toString() === fBed;
        return matchId && matchFor && matchLoc && matchType && matchBed;
      });
      renderList(filtered);
    }

    function renderList(data) {
      const list = document.getElementById('propertiesList');
      list.innerHTML = data.map(h => {
        let displayPrice = Number(h.price.toString().replace(/[^0-9.]/g, '')).toLocaleString();
        let stKey = h.status.toLowerCase().replace(/\s+/g, '_');
        let forClass = `pill-${h.forStatus.toLowerCase()}`;
        return `<div class="compact-item"><div style="display:flex; align-items:center;"><img class="compact-thumb" src="${h.img || 'https://placehold.co/100'}"><div class="compact-info"><b>${h.id} <span style="font-weight:300; font-size:9px;">[${h.type}]</span></b><small><span class="for-pill ${forClass}">${h.forStatus}</span> | üõèÔ∏è ${h.bed} | <b>${h.amphoe}</b></small></div></div><div class="compact-right"><span class="price-black">‡∏ø ${displayPrice}</span><br><span class="status-pill" style="color:#2e7d32; font-size:8px;">${h.status}</span></div></div>`;
      }).join('');
    }

    async function openProperties() {
      switchPage('propertiesPage');
      if(allHouses.length === 0) {
          document.getElementById('propertiesList').innerHTML = '<div style="text-align:center; padding:15px; font-size:10px;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
          const res = await fetch(`${API_URL}?action=getProperties`).then(r => r.json());
          allHouses = res.data;
      }
      applyFilters();
    }

    function switchPage(id) {
      ['loginPage', 'visitPage', 'historyPage', 'propertiesPage'].forEach(p => { const el = document.getElementById(p); if(el) el.style.display = 'none'; });
      document.getElementById(id).style.display = 'block';
      document.getElementById('filterHeader').style.display = (id === 'propertiesPage') ? 'block' : 'none';
      document.getElementById('bottomNav').style.display = (id === 'loginPage') ? 'none' : 'flex';
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      if(id === 'propertiesPage') document.getElementById('btnStock').classList.add('active');
      else if(id === 'visitPage' || id === 'historyPage') document.getElementById('btnCheckin').classList.add('active');
    }

    function showVisitPage() { const p = globalProfile; document.getElementById('vDispName').innerText = p.name; document.getElementById('vDispId').innerText = p.agentId; document.getElementById('vAgentImg').src = p.imgUrl || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png"; document.getElementById('vDispRole').innerText = `[${p.roleDisplay}]`; switchPage('visitPage'); }
    async function handleLogin() { const ph = document.getElementById('lPhone').value, ps = document.getElementById('lPass').value; Swal.showLoading(); const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json()); Swal.close(); if (res?.success) { localStorage.setItem('agent_phone', ph); localStorage.setItem('agent_pass', ps); globalProfile = res.profile; showVisitPage(); } else Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
    function handleLogout() { localStorage.clear(); location.reload(); }
  </script>
</body>
</html>
