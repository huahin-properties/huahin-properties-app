<!DOCTYPE html>
<html>
<head>
  <base target="_top"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --primary-green: #24d366; --st-approved: #e8f5e9; --st-approved-txt: #2e7d32; --st-pending: #fff3e0; --st-pending-txt: #e65100; --st-rejected: #ffebee; --st-rejected-txt: #c62828; }
    body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
    .header { background-color: var(--primary-green); color: white; padding: 20px 15px 40px; text-align: center; border-radius: 0 0 30px 30px; position: relative; }
    .container { padding: 15px; max-width: 450px; margin: 0 auto 80px; }
    .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .input-group { margin-bottom: 15px; text-align: left; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
    .input-group input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; }
    .menu-btn { width: 100%; padding: 15px; background: var(--primary-green); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    
    /* สไตล์รูปเอเจนต์เล็กๆ ด้านบน */
    .agent-mini-profile { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 12px; margin-bottom: 15px; }
    .agent-mini-profile img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary-green); object-fit: cover; }
    
    /* สไตล์สถานะการอนุมัติ */
    .status-item { display: flex; justify-content: space-between; padding: 10px; border-radius: 10px; margin-bottom: 8px; font-size: 13px; }
    .st-Approved { background: var(--st-approved); color: var(--st-approved-txt); }
    .st-Pending { background: var(--st-pending); color: var(--st-pending-txt); }
    .st-Rejected { background: var(--st-rejected); color: var(--st-rejected-txt); }
    
    .img-upload-box { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
    .img-preview { width: 80px; height: 80px; border-radius: 10px; border: 2px dashed #ccc; object-fit: cover; cursor: pointer; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; }
    .nav-item { flex: 1; padding: 12px 0; text-align: center; font-size: 11px; color: #999; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); }
  </style>
</head>
<body onload="initApp()">

  <div class="header">
    <div style="width: 60px; height: 60px; background: white; border-radius: 50%; margin: 0 auto 10px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
      <img src="https://img5.pic.in.th/file/secure-sv1/222892.jpg" style="width: 85%;">
    </div>
    <h1 style="font-size: 18px; margin: 0;">HUAHIN.PROPERTIES</h1>
  </div>

  <div class="container">
    <div id="visitPage" class="card" style="display:none;">
      <div class="agent-mini-profile">
        <img id="vAgentImg" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
        <div style="text-align: left;">
          <div style="font-weight: 600;">เอเจนต์: <span id="vDispName">...</span></div>
          <div style="font-size: 12px;">รหัส: <span id="vDispId" style="color:var(--primary-green);">...</span></div>
        </div>
      </div>
      
      <div class="input-group"><label>รหัสบ้าน (Property ID)</label><input type="text" id="vPropId"></div>
      <div class="input-group"><label>ชื่อลูกค้า</label><input type="text" id="vClientName"></div>
      
      <div class="input-group">
        <label>ถ่ายรูปหน้างาน (2 รูป)</label>
        <div class="img-upload-box">
          <img id="vImg1" src="https://placehold.co/80?text=Photo+1" class="img-preview" onclick="document.getElementById('file1').click()">
          <img id="vImg2" src="https://placehold.co/80?text=Photo+2" class="img-preview" onclick="document.getElementById('file2').click()">
          <input type="file" id="file1" style="display:none" onchange="previewImg(this, 'vImg1')">
          <input type="file" id="file2" style="display:none" onchange="previewImg(this, 'vImg2')">
        </div>
      </div>

      <button class="menu-btn" onclick="getLocation()" style="background:#4285F4;"><i class="fa-solid fa-map-marker-alt"></i> เช็คอินอัตโนมัติ (GPS)</button>
      <div id="locStatus" style="font-size: 12px; color: var(--primary-green); margin-bottom: 15px; display: none;">✅ พิกัดพร้อมส่ง</div>
      
      <div class="input-group"><label>บันทึก</label><input type="text" id="vNotes"></div>
      <button class="menu-btn" onclick="handleRecordVisit()">ยืนยันข้อมูล</button>
      <button class="menu-btn" onclick="switchPage('historyPage')" style="background:#666;"><i class="fa-solid fa-history"></i> ดูสถานะการอนุมัติ</button>
    </div>

    <div id="historyPage" class="card" style="display:none;">
      <h3 style="margin-top:0;">ประวัติการพาชม</h3>
      <div id="historyList">กำลังโหลด...</div>
      <button class="menu-btn" onclick="switchPage('visitPage')" style="margin-top:15px;">กลับ</button>
    </div>
    
    <div id="propertiesPage" style="display:none;"><div id="propertiesList"></div></div>
    <div id="loginPage" class="card" style="display:none;"> </div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;">
    <div class="nav-item" onclick="openProperties('home')"><i class="fa-solid fa-house"></i><div>Home</div></div>
    <div class="nav-item" onclick="switchPage('visitPage')"><i class="fa-solid fa-file-signature"></i><div>บันทึกพาชม</div></div>
    <div class="nav-item" onclick="handleLogout()"><i class="fa-solid fa-sign-out"></i><div>ออก</div></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyLB6o3Nqm8QtYSkneLHDva0T8hxkLHVl5iu1EM2IrswK8uyPkGQ4VlvP77nXHIBMB7KA/exec";
    let globalProfile = null, img1Base64 = "", img2Base64 = "", locationLink = "";

    async function initApp() {
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');
      const urlParams = new URLSearchParams(window.location.search);
      const target = urlParams.get('page');

      if (ph && ps) {
        const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
        if (res?.success) {
          globalProfile = res.profile;
          if (target === 'visit') showVisitPage(); else switchPage('visitPage');
        } else switchPage('loginPage');
      } else switchPage('loginPage');
    }

    function showVisitPage() {
      document.getElementById('vDispName').innerText = globalProfile.name;
      document.getElementById('vDispId').innerText = globalProfile.agentId;
      document.getElementById('vAgentImg').src = globalProfile.imgUrl || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
      switchPage('visitPage');
    }

    function previewImg(input, id) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById(id).src = e.target.result;
          if (id === 'vImg1') img1Base64 = e.target.result; else img2Base64 = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          locationLink = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
          document.getElementById('locStatus').style.display = 'block';
          Swal.fire('สำเร็จ', 'บันทึกพิกัดอัตโนมัติเรียบร้อย', 'success');
        });
      }
    }

    async function handleRecordVisit() {
      const data = { action: "recordVisit", agentId: globalProfile.agentId, agentName: globalProfile.name, agentPhone: globalProfile.phone, propertyId: document.getElementById('vPropId').value, clientName: document.getElementById('vClientName').value, notes: document.getElementById('vNotes').value, image1: img1Base64, image2: img2Base64, locationLink: locationLink };
      if (!data.propertyId || !data.clientName) return Swal.fire('เตือน', 'กรุณากรอกข้อมูลให้ครบ', 'warning');
      
      Swal.showLoading();
      const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json());
      Swal.close();
      if (res.success) Swal.fire('สำเร็จ', 'ส่งข้อมูลเรียบร้อย รอแอดมินอนุมัติ', 'success').then(() => location.reload());
    }

    async function loadHistory() {
      const res = await fetch(`${API_URL}?action=getVisitHistory&agentId=${globalProfile.agentId}`).then(r => r.json());
      const list = document.getElementById('historyList');
      list.innerHTML = res.history.map(item => `
        <div class="status-item st-${item.status}">
          <div style="text-align:left;">
            <b>ID: ${item.propertyId}</b><br><small>${item.date}</small>
          </div>
          <div style="text-align:right;">
            <b>${item.status}</b><br><small>${item.clientName}</small>
          </div>
        </div>
      `).join('');
    }

    function switchPage(id) {
      ['loginPage', 'visitPage', 'historyPage', 'propertiesPage'].forEach(p => { const el = document.getElementById(p); if(el) el.style.display = 'none'; });
      document.getElementById(id).style.display = 'block';
      if (id === 'historyPage') loadHistory();
      document.getElementById('bottomNav').style.display = (id !== 'loginPage') ? 'flex' : 'none';
    }

    // ฟังก์ชันช่วยอื่นๆ... (handleLogin, Logout ใช้ชุดเดิมครับ)
  </script>
</body>
</html>
