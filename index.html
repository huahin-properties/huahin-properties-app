<!DOCTYPE html>
<html>
<head>
  <base target="_top"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { 
      --primary-green: #24d366; 
      --st-Approved: #e8f5e9; --st-Approved-txt: #2e7d32;
      --st-Pending: #fff3e0; --st-Pending-txt: #e65100;
      --st-Rejected: #ffebee; --st-Rejected-txt: #c62828;
    }
    body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
    .header { background-color: var(--primary-green); color: white; padding: 20px 15px 40px; text-align: center; border-radius: 0 0 30px 30px; }
    .container { padding: 15px; max-width: 450px; margin: 0 auto 80px; }
    .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .input-group { margin-bottom: 15px; text-align: left; position: relative; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
    .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; font-family: 'Kanit'; }
    .eye-btn { position: absolute; right: 12px; top: 35px; color: #999; cursor: pointer; font-size: 18px; }
    .menu-btn { width: 100%; padding: 16px; background: var(--primary-green); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
    
    .agent-status-card { display: flex; align-items: center; gap: 15px; background: #fff; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 20px; }
    .agent-img-big { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-green); }
    .status-badge-agent { font-size: 11px; padding: 4px 12px; border-radius: 50px; font-weight: 600; display: inline-block; margin-top: 5px; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; }
    .nav-item { flex: 1; padding: 12px 0; text-align: center; font-size: 11px; color: #999; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); }
    .img-preview { width: 85px; height: 85px; border-radius: 10px; border: 2px dashed #ccc; object-fit: cover; cursor: pointer; }
  </style>
</head>
<body onload="initApp()">

  <div class="header">
    <h1 style="font-size: 18px; margin: 0;">HUAHIN.PROPERTIES</h1>
  </div>

  <div class="container">
    <div id="loginPage" class="card" style="display:none;">
      <h3 style="margin-top:0">Agent Login</h3>
      <div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="lPhone" placeholder="08x-xxxxxxx"></div>
      <div class="input-group">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="lPass" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
        <i class="fa-solid fa-eye eye-btn" id="toggleEye" onclick="togglePass('lPass', 'toggleEye')"></i>
      </div>
      <button class="menu-btn" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <div style="text-align:center; font-size:14px; margin-top:10px;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <span onclick="switchPage('registerPage')" style="color:var(--primary-green); cursor:pointer; font-weight:600;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
      </div>
    </div>

    <div id="registerPage" class="card" style="display:none;">
      <h3 style="margin-top:0">Agent Register</h3>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="rName"></div>
      <div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="rPhone" placeholder="08x-xxxxxxx"></div>
      <div class="input-group"><label>‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå</label><input type="text" id="rLine"></div>
      <div class="input-group"><label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="rPass"></div>
      <button class="menu-btn" onclick="handleRegister()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      <div onclick="switchPage('loginPage')" style="text-align:center; font-size:14px; margin-top:10px; cursor:pointer;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
    </div>

    <div id="visitPage" style="display:none;">
      <div class="agent-status-card">
        <img id="vAgentImg" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="agent-img-big">
        <div style="text-align: left;">
          <div style="font-weight: 600; font-size: 15px;"><span id="vDispName">...</span></div>
          <div style="font-size: 12px; color:#666;">ID: <span id="vDispId">...</span></div>
          <div id="vStatusBadge" class="status-badge-agent">Pending</div>
        </div>
      </div>

      <div id="checkinForm" class="card">
        <div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ö‡πâ‡∏≤‡∏ô (Property ID)</label><input type="text" id="vPropId" placeholder="HHXXXX"></div>
        <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="vClientName"></div>
        <div class="input-group">
          <label>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (2 ‡∏£‡∏π‡∏õ)</label>
          <div style="display:flex; gap:10px; justify-content:center;">
            <img id="vImg1" src="https://placehold.co/85?text=Photo+1" class="img-preview" onclick="document.getElementById('file1').click()">
            <img id="vImg2" src="https://placehold.co/85?text=Photo+2" class="img-preview" onclick="document.getElementById('file2').click()">
            <input type="file" id="file1" style="display:none" onchange="previewImg(this, 'vImg1')" accept="image/*">
            <input type="file" id="file2" style="display:none" onchange="previewImg(this, 'vImg2')" accept="image/*">
          </div>
        </div>
        <button class="menu-btn" onclick="getLocation()" style="background:#4285F4;"><i class="fa-solid fa-location-crosshairs"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</button>
        <div id="locStatus" style="font-size:12px; color:var(--primary-green); text-align:center; display:none; margin-bottom:10px;">‚úÖ ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
        <div class="input-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label><input type="text" id="vNotes"></div>
        <button class="menu-btn" onclick="handleRecordVisit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏≤‡∏ä‡∏°</button>
        <button class="menu-btn" onclick="switchPage('historyPage')" style="background:#666;">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      </div>

      <div id="lockMessage" class="card" style="display:none; text-align:center; padding:40px 10px;">
        <i class="fa-solid fa-lock" style="font-size:50px; color:#e65100; margin-bottom:15px;"></i>
        <h3 style="color:#e65100">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
        <p style="color:#666; font-size:14px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö</p>
        <button class="menu-btn" onclick="location.reload()" style="background:#eee; color:#333;">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>
    </div>

    <div id="historyPage" class="card" style="display:none;">
      <h3 style="margin-top:0">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏≤‡∏ä‡∏°</h3>
      <div id="historyList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      <button class="menu-btn" onclick="switchPage('visitPage')" style="margin-top:15px;">‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>

    <div id="propertiesPage" style="display:none;">
      <h3 style="margin-left:5px">üè† ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</h3>
      <div id="propertiesList"></div>
    </div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;">
    <div class="nav-item" onclick="openProperties('home')"><i class="fa-solid fa-house"></i><div>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div></div>
    <div class="nav-item active" onclick="switchPage('visitPage')"><i class="fa-solid fa-file-signature"></i><div>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div></div>
    <div class="nav-item" onclick="handleLogout()"><i class="fa-solid fa-sign-out"></i><div>‡∏≠‡∏≠‡∏Å</div></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyLB6o3Nqm8QtYSkneLHDva0T8hxkLHVl5iu1EM2IrswK8uyPkGQ4VlvP77nXHIBMB7KA/exec"; 
    let globalProfile = null, img1Base64 = "", img2Base64 = "", locationLink = "", allHouses = [];

    async function initApp() {
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');
      const urlParams = new URLSearchParams(window.location.search);
      const target = urlParams.get('page');

      if (ph && ps) {
        const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
        if (res?.success) { 
          globalProfile = res.profile; 
          if(target === 'properties') openProperties('home'); else showVisitPage(); 
        } 
        else switchPage('loginPage');
      } else {
        if (target === 'register') switchPage('registerPage');
        else switchPage('loginPage');
      }
    }

    function togglePass(id, eyeId) {
      const x = document.getElementById(id);
      const icon = document.getElementById(eyeId);
      if (x.type === "password") { x.type = "text"; icon.className = "fa-solid fa-eye-slash eye-btn"; } 
      else { x.type = "password"; icon.className = "fa-solid fa-eye eye-btn"; }
    }

    function showVisitPage() {
      const p = globalProfile;
      document.getElementById('vDispName').innerText = p.name;
      document.getElementById('vDispId').innerText = p.agentId;
      document.getElementById('vAgentImg').src = p.imgUrl || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
      const status = p.status ? p.status.toLowerCase() : 'pending';
      const badge = document.getElementById('vStatusBadge');
      
      if (status === 'admin' || status === 'approved' || status === 'active') {
        badge.innerText = "Verified Agent (Approved)"; badge.className = "status-badge-agent st-Approved";
        document.getElementById('checkinForm').style.display = 'block';
        document.getElementById('lockMessage').style.display = 'none';
      } else {
        badge.innerText = "Pending Approval"; badge.className = "status-badge-agent st-Pending";
        document.getElementById('checkinForm').style.display = 'none';
        document.getElementById('lockMessage').style.display = 'block';
      }
      switchPage('visitPage');
    }

    function previewImg(input, id) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById(id).src = e.target.result;
          if (id === 'vImg1') img1Base64 = e.target.result; else img2Base64 = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          locationLink = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
          document.getElementById('locStatus').style.display = 'block';
          Swal.fire('‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
        });
      }
    }

    async function handleRecordVisit() {
      const data = { action: "recordVisit", agentId: globalProfile.agentId, agentName: globalProfile.name, agentPhone: globalProfile.phone, propertyId: document.getElementById('vPropId').value, clientName: document.getElementById('vClientName').value, notes: document.getElementById('vNotes').value, image1: img1Base64, image2: img2Base64, locationLink: locationLink };
      if (!data.propertyId || !data.clientName) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'warning');
      Swal.showLoading();
      const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json());
      Swal.close();
      if (res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => location.reload());
    }

    async function handleLogin() {
      const ph = document.getElementById('lPhone').value, ps = document.getElementById('lPass').value;
      if(!ph || !ps) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
      Swal.showLoading();
      const res = await fetch(`${API_URL}?action=login&phone=${ph}&password=${ps}`).then(r => r.json());
      Swal.close();
      if (res?.success) {
        localStorage.setItem('agent_phone', ph); localStorage.setItem('agent_pass', ps);
        globalProfile = res.profile; showVisitPage();
      } else Swal.fire('Error', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
    }

    async function handleRegister() {
      const data = { action: "register", name: document.getElementById('rName').value, phone: document.getElementById('rPhone').value, lineId: document.getElementById('rLine').value, password: document.getElementById('rPass').value };
      if(!data.name || !data.phone || !data.password) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
      Swal.showLoading();
      const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json());
      Swal.close();
      if(res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö', 'success').then(() => switchPage('loginPage'));
    }

    async function loadHistory() {
      const res = await fetch(`${API_URL}?action=getVisitHistory&agentId=${globalProfile.agentId}`).then(r => r.json());
      const list = document.getElementById('historyList');
      list.innerHTML = res.history.map(item => `
        <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; background:${item.status==='Approved'?'#e8f5e9':'#fff'}">
          <div><b>${item.propertyId}</b><br><small>${item.clientName}</small></div>
          <div style="text-align:right"><b>${item.status}</b><br><small>${item.date.split(' ')[0]}</small></div>
        </div>`).join('');
    }

    function switchPage(id) {
      ['loginPage', 'registerPage', 'visitPage', 'historyPage', 'propertiesPage'].forEach(p => { if(document.getElementById(p)) document.getElementById(p).style.display = 'none'; });
      document.getElementById(id).style.display = 'block';
      document.getElementById('bottomNav').style.display = (id === 'loginPage' || id === 'registerPage') ? 'none' : 'flex';
      if(id === 'historyPage') loadHistory();
    }

    async function openProperties(cat) {
      switchPage('propertiesPage');
      if(allHouses.length === 0) {
        Swal.showLoading();
        allHouses = await fetch(`${API_URL}?action=getProperties&role=${globalProfile?.role || 'customer'}&lang=th`).then(r => r.json());
        Swal.close();
      }
      renderList(cat);
    }

    function renderList(cat) {
      const list = document.getElementById('propertiesList'); list.innerHTML = '';
      const filtered = allHouses.filter(h => cat === 'home' || h[cat] === "Y" || h[cat] === "TRUE");
      filtered.forEach(h => {
        list.innerHTML += `<div class="house-card">
          <img src="${h.img || 'https://placehold.co/100'}" class="house-img">
          <div class="house-info">
            <div class="house-title"><b>${h.title}</b></div>
            <div style="color:var(--app-red); font-weight:600;">‡∏ø ${h.price}</div>
            <div style="font-size:11px; color:#999; margin-top:3px;"><i class="fa-solid fa-bed"></i> ${h.bed} <i class="fa-solid fa-bath"></i> ${h.bath} | ID: ${h.id}</div>
          </div></div>`;
      });
    }

    function handleLogout() { localStorage.clear(); location.reload(); }
  </script>
</body>
</html>
